<template lang="html">
  <div :class="['image__lazy', 'u-abs', `--${fit}`]">
    <div class="image__lazy__svg" :style="`opacity: ${showImage ? 0 : 1};`">
      <div>
        <svg width="18" height="20" viewBox="0 0 18 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M0.215791 12.528V12.5351C0.527248 13.5922 0.997106 13.8409 1.18265 14.3174C1.29566 14.6011 1.64093 15.088 2.05295 15.0705C2.25163 15.059 2.4489 15.1121 2.61846 15.2227C2.55766 15.0519 2.501 14.8729 2.4485 14.6857C2.45339 14.6781 2.45917 14.6743 2.46496 14.6658C2.46496 14.6658 2.40222 13.9463 2.31324 13.0953L2.49121 13.8659C2.93215 15.7674 3.57998 16.9389 5.53015 18.3912C5.65785 18.4857 5.78065 18.5741 5.90034 18.6573C5.96034 18.6582 6.01823 18.6339 6.06141 18.5896C6.10458 18.5453 6.12953 18.4847 6.13082 18.4209C6.13148 18.4093 6.13148 18.3976 6.13082 18.386L5.4505 12.8386C5.44429 12.7891 5.42388 12.7428 5.39204 12.706C5.3602 12.6692 5.31847 12.6437 5.27253 12.633C4.78867 12.5332 4.34369 12.2827 3.99422 11.9134L4.0485 11.6298C3.90122 11.2787 3.88032 10.8824 3.98977 10.516C3.7469 10.4458 3.53938 10.2777 3.41135 10.0475H3.69255C3.79378 9.9296 3.90537 9.82227 4.02581 9.72694L4.36129 8.58949C4.05917 7.52429 3.83558 6.43571 3.69255 5.33361C3.57286 4.39566 2.34883 4.21176 1.99866 5.08022C1.88123 5.36999 1.78673 5.66965 1.71613 5.97609C1.38643 7.4232 1.50923 8.63582 1.73837 9.92503C1.58342 9.69772 1.36055 9.5329 1.10612 9.45747C0.292321 9.27168 -0.220249 10.403 0.0969928 12.026C0.133033 12.2127 0.173522 12.3782 0.215791 12.528Z"
            fill="white"
          />
          <path
            d="M14.3106 10.04H14.5931C14.465 10.2701 14.2575 10.4382 14.0147 10.5085C14.1237 10.8749 14.1027 11.2712 13.9555 11.6223L14.0098 11.9088C13.6607 12.2816 13.2146 12.5348 12.7288 12.6359C12.6829 12.6467 12.6413 12.6722 12.6095 12.709C12.5776 12.7458 12.5572 12.792 12.5508 12.8415L11.8759 18.3903C11.8721 18.4218 11.8741 18.4537 11.882 18.4843C11.8898 18.515 11.9032 18.5437 11.9215 18.5688C11.9397 18.5939 11.9625 18.6149 11.9884 18.6307C12.0143 18.6465 12.0429 18.6567 12.0725 18.6607H12.0819C12.2007 18.5775 12.3226 18.4914 12.4494 18.3969C14.3973 16.938 15.0492 15.7679 15.4861 13.8693L15.6111 13.3299C15.5337 14.074 15.4825 14.6654 15.4825 14.6654C15.4941 14.682 15.5057 14.6933 15.5172 14.7075C15.4638 14.8966 15.406 15.0762 15.3433 15.2488C15.5204 15.1187 15.7334 15.0551 15.9484 15.0682C16.3622 15.0857 16.7074 14.6007 16.8187 14.3151C17.0118 13.8386 17.479 13.5899 17.7855 12.5328V12.5257C17.83 12.3777 17.8687 12.2123 17.9043 12.0284C18.2216 10.4011 17.7108 9.27126 16.8948 9.45989C16.6404 9.53556 16.4176 9.70033 16.2625 9.92745C16.4917 8.63824 16.6145 7.42609 16.2848 5.97851C16.2195 5.6717 16.1302 5.37123 16.0178 5.08027C15.6699 4.20992 14.4458 4.39571 14.3306 5.33366C14.1864 6.43505 13.9618 7.52284 13.6587 8.58718L13.9942 9.72464C14.1085 9.81922 14.2144 9.92477 14.3106 10.04Z"
            fill="white"
          />
          <path
            d="M5.78338 9.10198C6.53088 9.2769 6.91174 9.91371 7.09461 10.3784C7.13652 10.4784 7.17161 10.5814 7.19962 10.6867C7.21608 10.7472 7.22765 10.7954 7.23566 10.8285C7.23521 10.8318 7.23521 10.8351 7.23566 10.8384L7.24322 10.8777V10.8847C7.30733 11.1922 7.32237 11.509 7.28771 11.8218V11.8515C7.28771 11.8515 7.28282 12.2973 7.22498 12.4567C7.17559 12.5942 6.59628 12.6486 6.43477 12.6623C6.43477 12.6623 6.36313 12.6765 6.24167 12.6878L7.05145 19.3197C7.0527 19.3285 7.05463 19.3372 7.05724 19.3457C7.06481 19.3801 7.07936 19.4124 7.09988 19.4402C7.1204 19.4681 7.14639 19.4908 7.17604 19.5069C7.61351 19.7423 8.08686 19.8932 8.57403 19.9527C8.67058 19.966 8.77425 19.9773 8.88148 19.9853V20H8.90373C8.93602 20.0011 8.96835 19.9991 9.00028 19.9938C9.0327 19.9898 9.06554 19.9919 9.09728 20H9.11952V19.9853C9.25567 19.9754 9.38337 19.9598 9.50617 19.9414C9.96563 19.8763 10.4115 19.7295 10.825 19.5069C10.8567 19.4896 10.8843 19.4648 10.9054 19.4342C10.9266 19.4037 10.9408 19.3684 10.9469 19.331V19.3197L11.7571 12.6864C11.6392 12.6751 11.5636 12.6609 11.5636 12.6609C11.4021 12.6472 10.8232 12.5928 10.7738 12.4553C10.7155 12.2959 10.7111 11.8501 10.7111 11.8501V11.8189C10.6764 11.5061 10.6914 11.1894 10.7556 10.8819V10.8748L10.7636 10.8356C10.764 10.8323 10.764 10.8289 10.7636 10.8257C10.7711 10.7916 10.7827 10.7434 10.7992 10.6838C10.8271 10.5785 10.8624 10.4754 10.9046 10.3756C11.0875 9.91323 11.4684 9.27643 12.2154 9.09914C12.2929 9.08103 12.3716 9.06902 12.4508 9.06321C12.9638 7.45867 13.9569 3.41282 13.0385 1.75485L12.8352 1.388L12.9638 1.3081C12.9135 1.27312 12.8672 1.23719 12.813 1.20551C11.7053 0.470271 10.4354 0.0571571 9.1302 0.00754326V-2.10319e-05C9.08965 -0.000903654 9.04909 0.00083302 9.00873 0.00517933C8.96813 0.0077796 8.92742 0.0077796 8.88682 0.00517933V0.0103797C7.57705 0.056238 6.30177 0.467962 5.18939 1.20409C5.13822 1.23813 5.09284 1.27406 5.03855 1.30668L5.16714 1.38705L4.96425 1.75344C4.04545 3.40809 5.03855 7.45726 5.55201 9.0618C5.62992 9.06944 5.70723 9.08287 5.78338 9.10198Z"
            fill="white"
          />
        </svg>
        <svg width="18" height="20" viewBox="0 0 18 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M0.215791 12.528V12.5351C0.527248 13.5922 0.997106 13.8409 1.18265 14.3174C1.29566 14.6011 1.64093 15.088 2.05295 15.0705C2.25163 15.059 2.4489 15.1121 2.61846 15.2227C2.55766 15.0519 2.501 14.8729 2.4485 14.6857C2.45339 14.6781 2.45917 14.6743 2.46496 14.6658C2.46496 14.6658 2.40222 13.9463 2.31324 13.0953L2.49121 13.8659C2.93215 15.7674 3.57998 16.9389 5.53015 18.3912C5.65785 18.4857 5.78065 18.5741 5.90034 18.6573C5.96034 18.6582 6.01823 18.6339 6.06141 18.5896C6.10458 18.5453 6.12953 18.4847 6.13082 18.4209C6.13148 18.4093 6.13148 18.3976 6.13082 18.386L5.4505 12.8386C5.44429 12.7891 5.42388 12.7428 5.39204 12.706C5.3602 12.6692 5.31847 12.6437 5.27253 12.633C4.78867 12.5332 4.34369 12.2827 3.99422 11.9134L4.0485 11.6298C3.90122 11.2787 3.88032 10.8824 3.98977 10.516C3.7469 10.4458 3.53938 10.2777 3.41135 10.0475H3.69255C3.79378 9.9296 3.90537 9.82227 4.02581 9.72694L4.36129 8.58949C4.05917 7.52429 3.83558 6.43571 3.69255 5.33361C3.57286 4.39566 2.34883 4.21176 1.99866 5.08022C1.88123 5.36999 1.78673 5.66965 1.71613 5.97609C1.38643 7.4232 1.50923 8.63582 1.73837 9.92503C1.58342 9.69772 1.36055 9.5329 1.10612 9.45747C0.292321 9.27168 -0.220249 10.403 0.0969928 12.026C0.133033 12.2127 0.173522 12.3782 0.215791 12.528Z"
            fill="white"
          />
          <path
            d="M14.3106 10.04H14.5931C14.465 10.2701 14.2575 10.4382 14.0147 10.5085C14.1237 10.8749 14.1027 11.2712 13.9555 11.6223L14.0098 11.9088C13.6607 12.2816 13.2146 12.5348 12.7288 12.6359C12.6829 12.6467 12.6413 12.6722 12.6095 12.709C12.5776 12.7458 12.5572 12.792 12.5508 12.8415L11.8759 18.3903C11.8721 18.4218 11.8741 18.4537 11.882 18.4843C11.8898 18.515 11.9032 18.5437 11.9215 18.5688C11.9397 18.5939 11.9625 18.6149 11.9884 18.6307C12.0143 18.6465 12.0429 18.6567 12.0725 18.6607H12.0819C12.2007 18.5775 12.3226 18.4914 12.4494 18.3969C14.3973 16.938 15.0492 15.7679 15.4861 13.8693L15.6111 13.3299C15.5337 14.074 15.4825 14.6654 15.4825 14.6654C15.4941 14.682 15.5057 14.6933 15.5172 14.7075C15.4638 14.8966 15.406 15.0762 15.3433 15.2488C15.5204 15.1187 15.7334 15.0551 15.9484 15.0682C16.3622 15.0857 16.7074 14.6007 16.8187 14.3151C17.0118 13.8386 17.479 13.5899 17.7855 12.5328V12.5257C17.83 12.3777 17.8687 12.2123 17.9043 12.0284C18.2216 10.4011 17.7108 9.27126 16.8948 9.45989C16.6404 9.53556 16.4176 9.70033 16.2625 9.92745C16.4917 8.63824 16.6145 7.42609 16.2848 5.97851C16.2195 5.6717 16.1302 5.37123 16.0178 5.08027C15.6699 4.20992 14.4458 4.39571 14.3306 5.33366C14.1864 6.43505 13.9618 7.52284 13.6587 8.58718L13.9942 9.72464C14.1085 9.81922 14.2144 9.92477 14.3106 10.04Z"
            fill="white"
          />
          <path
            d="M5.78338 9.10198C6.53088 9.2769 6.91174 9.91371 7.09461 10.3784C7.13652 10.4784 7.17161 10.5814 7.19962 10.6867C7.21608 10.7472 7.22765 10.7954 7.23566 10.8285C7.23521 10.8318 7.23521 10.8351 7.23566 10.8384L7.24322 10.8777V10.8847C7.30733 11.1922 7.32237 11.509 7.28771 11.8218V11.8515C7.28771 11.8515 7.28282 12.2973 7.22498 12.4567C7.17559 12.5942 6.59628 12.6486 6.43477 12.6623C6.43477 12.6623 6.36313 12.6765 6.24167 12.6878L7.05145 19.3197C7.0527 19.3285 7.05463 19.3372 7.05724 19.3457C7.06481 19.3801 7.07936 19.4124 7.09988 19.4402C7.1204 19.4681 7.14639 19.4908 7.17604 19.5069C7.61351 19.7423 8.08686 19.8932 8.57403 19.9527C8.67058 19.966 8.77425 19.9773 8.88148 19.9853V20H8.90373C8.93602 20.0011 8.96835 19.9991 9.00028 19.9938C9.0327 19.9898 9.06554 19.9919 9.09728 20H9.11952V19.9853C9.25567 19.9754 9.38337 19.9598 9.50617 19.9414C9.96563 19.8763 10.4115 19.7295 10.825 19.5069C10.8567 19.4896 10.8843 19.4648 10.9054 19.4342C10.9266 19.4037 10.9408 19.3684 10.9469 19.331V19.3197L11.7571 12.6864C11.6392 12.6751 11.5636 12.6609 11.5636 12.6609C11.4021 12.6472 10.8232 12.5928 10.7738 12.4553C10.7155 12.2959 10.7111 11.8501 10.7111 11.8501V11.8189C10.6764 11.5061 10.6914 11.1894 10.7556 10.8819V10.8748L10.7636 10.8356C10.764 10.8323 10.764 10.8289 10.7636 10.8257C10.7711 10.7916 10.7827 10.7434 10.7992 10.6838C10.8271 10.5785 10.8624 10.4754 10.9046 10.3756C11.0875 9.91323 11.4684 9.27643 12.2154 9.09914C12.2929 9.08103 12.3716 9.06902 12.4508 9.06321C12.9638 7.45867 13.9569 3.41282 13.0385 1.75485L12.8352 1.388L12.9638 1.3081C12.9135 1.27312 12.8672 1.23719 12.813 1.20551C11.7053 0.470271 10.4354 0.0571571 9.1302 0.00754326V-2.10319e-05C9.08965 -0.000903654 9.04909 0.00083302 9.00873 0.00517933C8.96813 0.0077796 8.92742 0.0077796 8.88682 0.00517933V0.0103797C7.57705 0.056238 6.30177 0.467962 5.18939 1.20409C5.13822 1.23813 5.09284 1.27406 5.03855 1.30668L5.16714 1.38705L4.96425 1.75344C4.04545 3.40809 5.03855 7.45726 5.55201 9.0618C5.62992 9.06944 5.70723 9.08287 5.78338 9.10198Z"
            fill="white"
          />
        </svg>
      </div>
    </div>
    <div
      class="image__lazy__img u-abs"
      :style="`
        opacity: ${showImage ? 1 : 0};
        transition: ${fadeIn ? `opacity ${fadeInDuration}ms ${fadeInDelay}ms cubic-bezier(0.16, 1, 0.3, 1)` : 'none'};
      `"
    >
      <img
        ref="image"
        :data-src="src"
        :width="width"
        :height="height"
        :alt="''"
        :class="[{ lazy: true, loading: loading, loaded: loaded }]"
        :style="`
          object-fit: ${fit};
          transform: ${fadeInScale ? (showImage ? 'scale(1)' : 'scale(1.35)') : 'none'};
          transition: transform 1s ${fadeInDelay}ms cubic-bezier(0.16, 1, 0.3, 1);
        `"
      />
    </div>
  </div>
</template>

<script>
const loadImage = (el, src, callback = () => {}) => {
  const img = new Image();
  if (img.decode) {
    img.src = src;
    img.decode().then(() => {
      el.src = src;
      callback();
    });
  } else {
    img.src = src;
    img.addEventListener(
      'load',
      () => {
        el.src = src;
        callback();
      },
      { once: true }
    );
  }
};

export default {
  name: 'Lazy',
  props: {
    src: {
      type: String,
      required: true,
      default: '',
    },
    width: {
      type: Number,
      default: 100,
    },
    height: {
      type: Number,
      default: 100,
    },
    fit: {
      type: String,
      default: 'cover',
    },
    fadeIn: {
      type: Boolean,
      default: true,
    },
    fadeInScale: {
      type: Boolean,
      default: true,
    },
    fadeInDuration: {
      type: String,
      default: '1500',
    },
    fadeInDelay: {
      type: String,
      default: '500',
    },
    fadeOnce: {
      type: Boolean,
      default: true,
    },
    lazy: {
      type: Boolean,
      default: true,
    },
  },
  data() {
    return {
      observer: null,
      loaded: false,
      loading: false,
      visible: false,
      options: {
        observerConfig: {
          rootMargin: '500px',
        },
      },
    };
  },
  computed: {
    showImage() {
      if (typeof window === 'undefined') {
        return false;
      }
      return this.loaded && this.visible;
    },
  },
  mounted() {
    if (this.lazy) {
      this.addIntersectionObserver();
    } else if (!this.lazy && this.$refs.image) {
      this.loadImage(this.$refs.image);
    }
  },
  destroyed() {
    if (this.observer) {
      this.observer.disconnect();
    }
  },
  methods: {
    addIntersectionObserver() {
      if (!this.$refs.image) {
        return;
      }
      this.observer = new IntersectionObserver((entries, self) => {
        entries.forEach((entry) => {
          if (!this.loaded) {
            if (entry.isIntersecting) {
              this.loadImage(entry.target);
              this.fadeOnce && self.unobserve(entry.target);
            }
          } else if (this.loaded && !this.fadeOnce) {
            if (entry.isIntersecting) {
              this.visible = true;
            } else {
              this.visible = false;
            }
          }
        });
      }, this.options.observerConfig);
      this.observer.observe(this.$refs.image);
    },
    loadImage(el) {
      const src = el.dataset.src;
      this.loading = true;
      loadImage(el, src, () => {
        requestAnimationFrame(() => {
          this.loading = false;
          this.loaded = true;
          this.visible = true;
        });
      });
    },
  },
};
</script>

<style lang="scss">
.image__lazy {
  overflow: hidden;
  // background: var(--black);
  &.--cover,
  &.--contain {
    picture,
    img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }
  }
  &__svg {
    display: flex;
    justify-content: center;
    align-items: center;
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    // z-index:2;
    transition: opacity 0.3s linear;
    > div {
      position: relative;
      svg {
        width: 40px;
        height: auto;
        &:first-child {
          path {
            fill: var(--purple);
          }
        }
        &:last-child {
          position: absolute;
          top: 0;
          left: 0;
          animation: clip 1s infinite ease-out;
        }
      }
    }
  }

  &__img {
    background: black;
    // z-index: 3;
  }

  @keyframes clip {
    0% {
      clip-path: polygon(0 100%, 100% 100%, 100% 100%, 0 100%);
    }
    50% {
      clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
    }
    100% {
      clip-path: polygon(0 0, 100% 0, 100% 0, 0 0);
    }
  }
}
</style>
